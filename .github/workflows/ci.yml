name: Zenith CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          gcc \
          g++ \
          uuid-dev \
          libgtest-dev \
          libantlr4-runtime-dev \
          antlr4
        
        # Install ANTLR4 if not available via apt
        if ! command -v antlr4 &> /dev/null; then
          echo "Installing ANTLR4..."
          cd /usr/local/lib
          sudo wget https://www.antlr.org/download/antlr-4.13.1-complete.jar
          echo '#!/bin/bash' | sudo tee /usr/local/bin/antlr4_new
          echo 'java -jar /usr/local/lib/antlr-4.13.1-complete.jar "$@"' | sudo tee -a /usr/local/bin/antlr4_new
          sudo chmod +x /usr/local/bin/antlr4_new
        fi
    
    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_COMPILER=g++
    
    - name: Build
      run: cmake --build build --config Release
    
    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose
      
    - name: Test compiler binary
      run: |
        ./build/zenith tests/test_basic.zenith -o build/test_output
        echo "✓ Compiler executable works"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: zenith-compiler
        path: build/zenith
        retention-days: 7

  test-examples:
    name: Test Example Programs
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download compiler
      uses: actions/download-artifact@v4
      with:
        name: zenith-compiler
        path: .
        
    - name: Make executable
      run: chmod +x zenith
    
    - name: Test basic example
      run: |
        if [ -f tests/test_basic.zenith ]; then
          ./zenith tests/test_basic.zenith -o test_basic
          echo "✓ Basic test compiled"
        fi

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check file formatting
      run: |
        echo "Checking C++ files..."
        find src include -name "*.cpp" -o -name "*.h" | wc -l
        echo "✓ Source files found"
        
    - name: Check grammar files
      run: |
        echo "Checking ANTLR grammar..."
        test -f grammar/ZenithLexer.g4 && echo "✓ Lexer grammar exists"
        test -f grammar/ZenithParser.g4 && echo "✓ Parser grammar exists"
